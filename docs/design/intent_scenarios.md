# 意图识别主要场景设计

基于订机票和查银行卡余额两个示例意图，设计各种复杂场景的处理流程。系统采用B2B无状态设计，支持混合Prompt Template配置、RAGFLOW集成、智能歧义处理等高级功能。

## 1. 基础场景

### 1.1 订机票 - 完整信息场景
**用户输入**: "我想订一张明天从北京到上海的机票"
**系统处理**:
- 意图识别: book_flight (confidence: 0.95)
- 槽位提取: departure_city=北京, arrival_city=上海, departure_date=明天
- 槽位验证: 全部通过
- 缺失槽位: 无
- 系统响应: 直接调用订机票API
- status: completed
- response_type: api_result

### 1.2 查余额 - 信息不完整场景
**用户输入**: "查余额"
**系统处理**:
- 意图识别: check_balance (confidence: 0.85)
- 槽位提取: 无
- 缺失槽位: card_number (必填)
- 系统响应: "请提供您的银行卡号（16位数字）"
- status: incomplete
- response_type: slot_prompt
- 智能提示: 根据用户历史提供卡号掩码提示

## 2. 意图歧义场景

### 2.1 相似意图歧义
**用户输入**: "我想订票"
**系统处理**:
- 候选意图: 
  - book_flight (confidence: 0.72)
  - book_train (confidence: 0.68) 
  - book_movie (confidence: 0.65)
- 歧义检测: 最高置信度差值 < 0.1
- 歧义处理策略: 系统自动生成澄清问题
- 系统响应: "请问您想要预订哪种票？\n1. 机票\n2. 火车票\n3. 电影票"
- status: ambiguous
- response_type: disambiguation

### 2.2 上下文相关歧义
**用户输入**: "我要去上海"
**系统处理**:
- 候选意图:
  - book_flight (confidence: 0.65)
  - book_train (confidence: 0.63)
  - book_hotel (confidence: 0.60)
- 上下文分析: 无相关历史，检查用户偏好
- 智能歧义处理: 结合用户历史和当前时间
- 系统响应: "请问您是想要：\n1. 预订去上海的机票\n2. 预订去上海的火车票\n3. 预订上海的酒店"
- status: ambiguous
- response_type: disambiguation
- 支持用户优先级和业务规则驱动

## 3. 意图转移场景

### 3.1 对话中主动转移
**对话流程**:
```
用户: "我想订机票"
系统: "好的，请告诉我出发城市是哪里？"
用户: "算了，我先查一下余额"
系统处理:
- 检测到意图转移: book_flight -> check_balance
- 清理当前槽位缓存
- 切换到新意图处理
系统: "好的，请提供您的银行卡号（16位数字）"
```

### 3.2 槽位填充中的意图转移
**对话流程**:
```
用户: "我想订机票"
系统: "请告诉我出发城市是哪里？"
用户: "北京"
系统: "请告诉我到达城市是哪里？"
用户: "等等，我想先查一下余额，卡号是6222080012345678"
系统处理:
- 检测意图转移: book_flight -> check_balance
- 意图转移阈值检查: check_balance confidence > 0.7
- 提取新意图槽位: card_number=6222080012345678
- 保存原意图进度到上下文 (departure_city=北京)
- 支持嵌套意图处理
系统: "好的，正在查询余额..."
- status: intent_transfer
- response_type: intent_transfer_with_completion
```

## 4. 打岔场景

### 4.1 闲聊打岔
**对话流程**:
```
用户: "我想订机票"
系统: "请告诉我出发城市是哪里？"
用户: "今天天气真好啊"
系统处理:
- 意图识别: small_talk (confidence: 0.85)
- 判断为打岔，非意图转移 (confidence < 意图转移阈值)
- 调用RAGFLOW API处理闲聊
- 保持原意图上下文 (book_flight)
- 区分打岔和真正的意图转移
系统: "是的，天气很不错呢！回到我们的机票预订，请告诉我出发城市是哪里？"
- status: interruption_handled
- response_type: small_talk_with_context_return
```

### 4.2 信息确认打岔
**对话流程**:
```
用户: "我想订机票"
系统: "请告诉我出发城市是哪里？"
用户: "什么是经济舱？"
系统处理:
- 意图识别: information_query (confidence: 0.80)
- 判断为相关信息查询，非意图转移
- 调用RAGFLOW API获取回答
- 保持原意图上下文 (book_flight)
- 智能关联：查询内容与当前意图相关
系统: "经济舱是标准座位等级，价格较为实惠，座位空间适中。您想选择经济舱吗？请先告诉我出发城市。"
- status: interruption_handled
- response_type: qa_response
```

## 5. 反向生成场景

### 5.1 基于历史的智能反问
**上下文**: 用户上次订过北京到上海的机票
**用户输入**: "我想订机票"
**系统处理**:
- 意图识别: book_flight (confidence: 0.90)
- 分析历史记录
- 生成个性化反问
**系统响应**: "好的，您是想要预订机票。根据您的历史记录，是否还是从北京到上海？"

### 5.2 槽位依赖的智能反问
**对话流程**:
```
用户: "我想订机票"
系统: "请告诉我出发城市是哪里？"
用户: "北京"
系统处理:
- 已知: departure_city=北京
- 分析常见航线
- 生成智能反问
系统: "好的，从北京出发。请问您是要去上海、广州、深圳还是其他城市？"
```

## 6. 用户澄清回复场景

### 6.1 歧义澄清回复
**对话流程**:
```
系统: "请问您想要预订哪种票？\n1. 机票\n2. 火车票\n3. 电影票"
用户: "机票"
系统处理:
- 解析用户选择
- 确认意图: book_flight
- 清理歧义状态
- 继续槽位填充
系统: "好的，预订机票。请告诉我出发城市是哪里？"
```

### 6.2 数字选择澄清
**对话流程**:
```
系统: "请问您想要预订哪种票？\n1. 机票\n2. 火车票\n3. 电影票"
用户: "1"
系统处理:
- 解析数字选择: 1 -> book_flight
- 确认意图选择
- 继续意图处理
系统: "好的，预订机票。请告诉我出发城市是哪里？"
```

## 7. 错误处理场景

### 7.1 API调用失败
**对话流程**:
```
用户: "我想订从北京到上海明天的机票"
系统处理:
- 意图识别成功，槽位完整
- 调用订机票API失败
- 返回错误信息
系统: "很抱歉，机票预订服务暂时不可用，请稍后重试或联系客服。您可以先查看其他航班信息吗？"
```

### 7.2 槽位验证失败
**对话流程**:
```
用户: "我想订机票，从北京到北京"
系统处理:
- 意图识别: book_flight
- 槽位验证失败: 出发城市和到达城市相同
- 生成错误反问
系统: "出发城市和到达城市不能相同，请重新告诉我您要去哪个城市？"
```

## 8. 上下文继承场景

### 8.1 多轮对话中的上下文继承
**对话流程**:
```
用户: "我想订机票"
系统: "请告诉我出发城市是哪里？"
用户: "北京"
系统: "请告诉我到达城市是哪里？"
用户: "上海，对了，我想要商务舱"
系统处理:
- 继承上下文: departure_city=北京
- 新增信息: arrival_city=上海, seat_class=商务舱
- 智能补全其他信息
系统: "好的，北京到上海的商务舱。请告诉我出发日期是哪天？"
```

### 8.2 跨意图的上下文利用
**对话流程**:
```
用户: "查余额，卡号6222080012345678"
系统: "您的银行卡余额为：5000元"
用户: "我想订机票"
系统处理:
- 检测到新意图
- 分析余额信息，判断支付能力
- 生成个性化建议
系统: "好的，预订机票。根据您的余额情况，建议选择经济舱。请告诉我出发城市是哪里？"
```

## 9. 复杂混合场景

### 9.1 多意图混合处理
**用户输入**: "我想查一下余额然后订机票，卡号是6222080012345678，要从北京到上海"
**系统处理**:
- 检测多意图: check_balance + book_flight
- 按优先级排序处理
- 提取各意图槽位
- 制定处理策略
**系统响应**: "好的，我先为您查询余额，然后帮您预订北京到上海的机票。正在查询余额..."

### 9.2 嵌套意图处理
**对话流程**:
```
用户: "我想订机票"
系统: "请告诉我出发城市是哪里？"
用户: "北京，不过我想先确认一下余额够不够，卡号6222080012345678"
系统处理:
- 主意图: book_flight (进行中)
- 嵌套意图: check_balance (新增)
- 处理策略: 先处理嵌套意图，再回到主意图
系统: "好的，我先为您查询余额。正在查询中..."
查询完成后: "您的余额为5000元，足够购买机票。回到机票预订，出发城市是北京，请告诉我到达城市是哪里？"
```

## 10. 用户拒答/否定意图场景

### 10.1 用户拒绝当前意图
**对话流程**:
```
用户: "我想订机票"
系统: "请告诉我出发城市是哪里？"
用户: "北京"
系统: "请告诉我到达城市是哪里？"
用户: "我不订了"
系统处理:
- 意图识别: cancel_intent (confidence: 0.92)
- 检测到用户拒绝当前意图
- 保存取消原因和已填充槽位
- 提供其他服务建议
系统: "好的，已取消机票预订。如果您有其他需要帮助的地方，请随时告诉我。"
- status: intent_cancelled
- response_type: cancellation_confirmation
```

### 10.2 用户表达犹豫/延迟决定
**对话流程**:
```
用户: "我想订酒店"
系统: "请告诉我您要在哪个城市订酒店？"
用户: "上海"
系统: "请告诉我入住日期是哪天？"
用户: "算了，我再想想"
系统处理:
- 意图识别: postpone_intent (confidence: 0.88)
- 保存当前进度到上下文
- 设置上下文过期时间
- 提供恢复建议
系统: "没问题，您可以慢慢考虑。我已经为您保存了酒店预订信息：上海。当您确定后随时可以继续完成预订。"
- status: intent_postponed
- response_type: postponement_with_save
```

### 10.3 用户明确拒绝系统建议
**对话流程**:
```
系统: "根据您的历史记录，推荐预订北京到上海的机票"
用户: "不用了，我不需要这个服务"
系统处理:
- 意图识别: reject_suggestion (confidence: 0.90)
- 更新用户偏好设置
- 减少主动推荐频率
- 提供其他服务选项
系统: "好的，我理解您现在不需要这个服务。如果将来有需要，我随时为您提供帮助。还有什么其他我可以协助您的吗？"
- status: suggestion_rejected
- response_type: rejection_acknowledgment
```

## 11. 混合Prompt Template配置场景

### 11.1 数据库配置优先于配置文件
**场景**: 订机票意图使用自定义模板
**配置策略**:
- 数据库中存储book_flight专用识别模板
- 配置文件中定义通用意图识别模板
- 优先级：数据库配置 > 配置文件 > 系统默认

**处理流程**:
```
用户: "我想飞到上海"
系统处理:
- 加载意图识别模板：优先从数据库获取book_flight专用模板
- 使用自定义模板进行意图识别
- 提高识别准确性：confidence从0.85提升到0.92
- 支持A/B测试不同模板版本
```

### 11.2 模板版本管理和A/B测试
**场景**: 槽位提取模板优化
**配置策略**:
- 版本A：当前使用的槽位提取模板
- 版本B：优化后的新模板
- 流量分割：50%用户使用版本A，50%使用版本B

**处理流程**:
```
用户: "明天从北京到上海的机票"
系统处理:
- 根据A/B测试配置选择模板版本
- 版本A：提取3个槽位 (departure_city, arrival_city, departure_date)
- 版本B：提取4个槽位 (增加passenger_count默认值)
- 记录模板性能指标用于优化决策
```

## 12. RAGFLOW集成场景

### 12.1 非意图输入处理
**场景**: 用户询问知识性问题
**对话流程**:
```
用户: "什么是人工智能的发展历程？"
系统处理:
- 意图识别结果：所有意图confidence都很低 (<0.5)
- 判定为非意图输入
- 调用RAGFLOW API处理知识问答
- 返回详细回答并保持对话开放性
系统: "人工智能的发展历程可以追溯到1950年代...[详细回答]...您还有什么其他问题吗？如果需要订票、查询余额等服务，我也可以帮助您。"
- status: ragflow_handled
- response_type: qa_response
```

### 12.2 RAGFLOW回退机制
**场景**: 意图识别失败的兜底处理
**对话流程**:
```
用户: "那个啥来着的东西"
系统处理:
- 意图识别失败：无法理解用户输入
- 尝试上下文分析：无有效上下文
- 启动RAGFLOW回退机制
- 生成澄清性回复
系统: "抱歉，我没有完全理解您的意思。您可以详细描述一下您需要什么帮助吗？我可以协助您订票、查询余额或回答其他问题。"
- status: intent_not_found
- response_type: clarification_request
```

## 13. 安全和验证场景

### 13.1 输入安全校验
**场景**: 防注入攻击
**处理流程**:
```
用户: "'; DROP TABLE intents; --"
系统处理:
- 输入sanitization检查
- 检测到潜在SQL注入攻击
- 清理恶意输入
- 记录安全日志
系统: "抱歉，您的输入包含无效字符，请重新输入您的需求。"
- status: validation_error
- response_type: security_error
```

### 13.2 槽位验证失败处理
**场景**: 银行卡号格式验证
**对话流程**:
```
用户: "查余额，卡号是123"
系统处理:
- 意图识别: check_balance (confidence: 0.90)
- 槽位提取: card_number=123
- 槽位验证失败：卡号长度不足16位
- 生成友好错误提示
系统: "银行卡号格式不正确，请提供完整的16位银行卡号。"
- status: validation_error
- response_type: validation_error_prompt
```

## 14. 性能优化场景

### 14.1 Redis缓存命中
**场景**: 高频查询优化
**处理流程**:
```
用户: "我想订机票"
系统处理:
- 检查Redis缓存：intent_config:book_flight
- 缓存命中，直接加载配置
- 响应时间：50ms (vs 200ms从数据库加载)
- 缓存TTL：1小时
```

### 14.2 异步API调用
**场景**: 外部API调用超时处理
**处理流程**:
```
用户: "订从北京到上海明天的机票"
系统处理:
- 意图识别和槽位填充完成
- 调用订机票API：超时(>30秒)
- 启动异步处理机制
- 返回处理中状态
系统: "正在为您预订机票，由于网络繁忙可能需要稍等片刻。我们会尽快处理并通知您结果。"
- status: api_processing
- response_type: async_processing
```

## 15. 场景配置要求

### 15.1 意图转移检测阈值
- 新意图置信度 > 0.7
- 新意图置信度 > 当前意图置信度 + 0.1
- 支持意图转移白名单配置
- 意图转移优先级和业务规则驱动

### 15.2 打岔检测规则
- 闲聊类意图不触发转移 (confidence < 意图转移阈值)
- 信息查询类意图保持上下文
- 紧急类意图（如查余额）可中断其他意图
- 区分打岔和真正的意图转移

### 15.3 智能反问生成策略
- 基于用户历史偏好和个性化推荐
- 考虑当前时间、季节和上下文
- 结合业务规则和推荐算法
- 支持A/B测试不同反问模板
- 上下文感知的反向提问生成

### 15.4 上下文管理策略
- 会话级上下文：整个会话期间保持
- 意图级上下文：单个意图处理期间保持
- 槽位级上下文：支持槽位值的继承和覆盖
- 历史上下文：跨会话的用户偏好记忆
- 智能槽位继承：跨意图和跨会话的槽位值复用

### 15.5 混合Prompt Template配置策略
- 数据库存储：意图相关的自定义prompt template
- 配置文件存储：通用的基础prompt template
- 优先级策略：数据库配置 > 配置文件 > 系统默认
- 模板版本管理：支持A/B测试版本控制
- 动态模板变量：支持上下文注入和动态替换

### 15.6 RAGFLOW集成配置
- API健康检查和备用fallback机制
- 智能路由决策：基于置信度阈值和业务规则
- 上下文感知：维持对话上下文的无缝集成
- 错误处理：API调用失败时的降级策略

### 15.7 安全配置要求
- 输入sanitization：防止SQL注入和XSS攻击
- JWT认证：用户身份认证和权限控制
- 数据加密：敏感数据传输和存储加密
- 审计日志：记录所有配置变更和敏感操作
- IP白名单：支持IP访问控制

### 15.8 性能配置要求
- Redis缓存：配置数据TTL=1小时，NLU结果TTL=30分钟
- 响应时间：<2秒，支持异步处理
- 并发控制：单用户最多5个并发，系统级最多1000个
- 监控告警：集成Prometheus，99.9% uptime保证
- 错误重试：最大重试3次，防止资源滥用

### 15.9 业务配置要求
- 意图优先级：支持业务规则驱动的优先级管理
- 槽位验证：支持复杂业务逻辑校验和依赖关系
- 个性化配置：基于用户历史的偏好设置和推荐
- 多语言支持：支持中英文意图识别和响应
- 热更新：配置变更后通过Redis Pub/Sub实时生效