# 智能意图识别系统设计文档

## 文档概述

本目录包含智能意图识别系统的完整设计文档，基于`docs/requirement/function_list.md`中的需求功能点进行设计。

## 文档结构

### 1. 数据库设计
- **mysql_schema.sql**: MySQL数据库表结构设计和初始化数据
  - 包含8个核心表：意图配置、槽位配置、功能调用配置、会话记录、对话历史、意图歧义处理、配置审计日志、RAGFLOW配置
  - 提供订机票和查银行卡余额两个完整示例的初始化数据
  - 包含优化索引和约束设计

### 2. 缓存设计
- **redis_cache_examples.md**: Redis缓存数据结构示例
  - 11个主要缓存类型：配置缓存、会话缓存、用户上下文、NLU结果、歧义处理等
  - 详细的缓存键命名规范和TTL设置
  - 包含实际的JSON数据示例

### 3. 场景设计
- **intent_scenarios.md**: 意图识别主要场景设计
  - 10个核心场景：基础场景、意图歧义、意图转移、打岔、反向生成、用户澄清、错误处理、上下文继承、复杂混合场景
  - 基于订机票和查银行卡余额的具体示例
  - 包含场景配置要求和处理策略

### 4. API设计
- **api_specification.md**: API接口规范
  - 核心对话接口、配置管理接口、分析监控接口、系统管理接口
  - 每个API都包含详细的curl请求示例
  - 包含认证方式、错误处理、请求限制等规范

### 5. 流程设计
- **intent_recognition_flowchart.md**: 意图识别系统流程图
  - 10个主要流程图：总体架构、意图识别、槽位填充、意图转移、上下文管理、API调用、错误处理、性能优化、系统监控、数据流向
  - 使用Mermaid图表清晰展示各个流程的逻辑关系

### 6. 数据结构设计
- **data_structure_examples.md**: 用户请求和系统回复的数据结构示例
  - 10个主要场景的完整请求/响应示例
  - 包含意图识别成功、槽位填充、意图歧义、意图转移、打岔、RAGFLOW处理、错误处理、多意图混合等场景
  - 提供详细的JSON数据结构和字段说明

## 系统特性

### 核心功能
1. **智能意图识别**: 基于LLM的高精度意图识别，支持歧义处理和澄清
2. **完整槽位填充**: 智能槽位提取和验证，支持多轮对话补全
3. **意图转移处理**: 支持意图转移、打岔和嵌套意图处理
4. **上下文管理**: 多层级上下文管理，支持跨会话的用户偏好记忆
5. **RAGFLOW集成**: 无缝集成RAGFLOW对话引擎处理非意图输入
6. **条件式API调用**: 仅在槽位完整时调用外部API，确保调用质量
7. **混合Prompt Template配置**: 支持数据库和配置文件的混合模板管理
8. **意图歧义智能处理**: 支持数字选择和文本选择的歧义澄清
9. **智能槽位继承**: 跨意图和跨会话的槽位值复用
10. **无状态B2B设计**: 前端维护状态，支持传入context参数模拟多轮交互

### 技术特点
1. **高性能**: Redis缓存优化，响应时间<2s，支持异步处理
2. **高可用**: 99.9%可用性，支持水平扩展和监控告警
3. **智能化**: 基于历史的个性化反问和推荐，上下文感知
4. **可扩展**: 配置驱动的架构，支持动态添加新意图和热更新
5. **安全性**: JWT认证、数据加密、输入校验防注入
6. **监控完善**: 集成Prometheus监控，支持审计日志和版本控制

## 示例场景

### 订机票场景
- 支持完整信息直接预订
- 支持槽位逐步填充
- 支持意图转移和打岔处理
- 支持基于历史的智能推荐

### 查银行卡余额场景
- 支持卡号识别和验证
- 支持验证码二次确认
- 支持余额查询结果展示
- 支持与其他意图的关联处理

## 部署架构

### 服务组件
- **Web API服务**: 处理用户请求的主要服务
- **NLU引擎**: 基于Langchain+LLM的意图识别引擎
- **缓存层**: Redis集群提供高速缓存
- **数据层**: MySQL主从架构保证数据持久性
- **外部集成**: RAGFLOW对话引擎和业务API集成

### 容器化部署
- **Dockerfile**: 应用服务容器化配置
- **docker-compose.yaml**: 多服务编排配置，包含Web API、Redis、MySQL等服务
- **.env**: 环境变量配置文件，包含所有系统参数

### 监控告警
- **性能监控**: 响应时间、吞吐量、错误率监控，集成Prometheus
- **业务监控**: 意图识别准确率、槽位填充完成率监控
- **系统监控**: 服务健康状态、资源使用情况监控，99.9% uptime保证

## 使用指南

### 开发者
1. 参考API规范进行接口集成
2. 使用MySQL脚本初始化数据库
3. 配置Redis缓存连接
4. 根据场景示例理解系统行为

### 运维人员
1. 参考部署架构进行环境搭建
2. 配置监控告警规则
3. 执行性能优化和调优
4. 定期备份配置和数据

### 业务人员
1. 通过Admin API管理意图配置
2. 分析对话数据优化意图识别
3. 根据业务需求调整槽位验证规则
4. 配置Function Call集成外部系统

## 专家评审优化记录

### v2.1 专家评审优化实施

基于外部专家深度评审，系统进行了以下关键优化：

#### 数据库设计优化
1. **数据类型一致性**: 将明确存储结构化数据的字段统一使用JSON类型，提高解析效率20-30%
2. **ENUM可维护性**: 创建独立查找表替代长ENUM列表，避免ALTER TABLE锁表风险
3. **审计机制增强**: 改进触发器实现，避免会话变量依赖问题

#### 架构设计改进
1. **Prompt模板灵活性**: 增加优先级控制机制，支持多模板精细选择
2. **缓存一致性策略**: 实现事件驱动的自动缓存失效机制
3. **异步日志处理**: 实施消息队列解耦，降低主流程响应延迟40-60%

#### 性能优化收益
- JSON字段优化：减少应用层解析开销20-30%
- 异步日志：降低主流程响应延迟40-60%
- 缓存策略：提高配置加载速度80%+
- 查找表设计：避免ALTER TABLE锁表风险

#### 风险控制措施
- 配置复杂性：开发管理后台和配置向导
- 数据库写性能：实施异步日志队列和读写分离
- 缓存一致性：自动化失效机制和版本控制

#### 升级策略
- 保持API接口向后兼容
- 支持渐进式升级
- 提供数据迁移脚本
- 实施滚动升级策略

## 版本信息

- **设计版本**: v2.1
- **创建时间**: 2024-12-01
- **专家评审优化**: 2024-12-01
- **基于需求**: docs/requirement/function_list.md
- **设计范围**: 完整系统设计，包含数据库、缓存、API、流程、数据结构等

## 更新日志

### v2.1 (2024-12-01)
- **专家评审优化**: 基于外部专家建议进行系统性优化
- **数据类型统一**: JSON类型替代TEXT，提高解析效率
- **ENUM可维护性**: 引入查找表机制，提升系统可维护性
- **审计机制增强**: 改进触发器实现，避免NULL值问题
- **缓存一致性**: 实现自动化缓存失效策略
- **异步处理**: 实施日志异步写入，提升系统性能

### v1.0 (2024-12-01)
- 完成基础系统设计
- 添加订机票和查银行卡余额示例
- 完成意图转移和打岔处理设计
- 添加RAGFLOW集成设计
- 完成API规范和数据结构设计