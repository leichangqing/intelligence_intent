# 智能意图识别系统需求功能点

功能点按模块划分，涵盖意图识别、槽位填充、API调用、对话引擎集成、会话管理以及Admin维护。系统设计为开放式意图识别服务，供各业务系统集成使用。系统为B2B无状态设计，上下文由前端维护，但支持传入context参数模拟多轮交互。

## 1. 系统总体功能
- **智能意图识别与处理**：精准识别用户意图，完成槽位实体填值后直接调用目标系统API，实现端到端的意图处理流程。API调用超时机制，支持异步回调以确保实时性。
- **三层响应策略**：
  - 意图识别成功且槽位完整 → 直接调用系统API
  - 非意图输入 → 调用RAGFLOW API对话引擎响应
  - 意图识别有歧义 → 基于上下文生成反向澄清问题
- **配置驱动**：所有意图、槽位和Function Call配置从MySQL数据库加载，支持动态维护和热更新。加强事务管理和一致性校验，以防高并发数据不一致
- **NLU框架切换**：使用Langchain + LLM（e.g., GPT-4或本地Llama）+ Duckling实现意图识别和槽位提取，提升灵活性和准确性。
- **智能对话优化**：通过上下文感知的反向提问，减少多轮交互，提高沟通效率。
- **性能优化**：使用Redis缓存配置和NLU结果，响应时间<2s，支持异步处理，集成监控工具如Prometheus，确保99.9% uptime。
- **安全性与可用性**：JWT认证、数据加密、99.9% uptime，支持水平扩展。

## 2. 配置管理功能
- **数据库存储**：使用MySQL（Peewee ORM）存储意图、槽位、Function Call和审计日志，支持版本控制。
- **CRUD操作**：通过Admin API实现配置的创建、读取、更新和删除，支持实时生效。
- **热更新**：配置变更后，通过Redis Pub/Sub通知系统刷新缓存，无需重启服务，心跳检测和自动重试机制，以处理网络延迟导致的不同步
- **加载机制**：启动/请求时优先从Redis加载配置，若失效则查询MySQL并缓存（TTL=1小时）。根据变更频率动态调整TTL，以避免陈旧数据。
- **混合Prompt Template配置策略**：
  - **数据库存储**：在MySQL中存储意图相关的自定义prompt template，支持意图级别的模板定制
  - **配置文件存储**：在配置文件中定义通用的基础prompt template，作为系统默认模板
  - **优先级策略**：数据库配置 > 配置文件 > 系统默认，支持运行时动态调整和覆盖
  - **模板版本管理**：支持A/B测试版本控制，记录模板变更历史和性能指标。

## 3. 意图识别与槽位填充功能
- **精准意图识别**：使用Langchain的LLMChain和Few-Shot Prompting，基于混合Prompt Template配置和DB中的examples分类意图，输出JSON包含intent、confidence和recognition_type。允许业务自定义置信度阈值，如confidence差值<0.1可配置。
  - **默认模板**：在配置文件中定义基础的意图识别prompt template
  - **自定义模板**：在MySQL数据库中存储特定意图的自定义prompt template
  - **优先级策略**：数据库配置优先于配置文件，支持运行时动态调整
- **意图歧义智能处理**：
  - 检测多个近似意图（confidence差值<0.1）
  - 基于上下文和历史对话生成澄清问题
  - 支持意图优先级和业务规则驱动的歧义解决
  - 支持数字选择和文本选择的歧义澄清
  - 系统自动识别歧义澄清响应，无需前端指定消息类型。
- **意图转移与打岔处理**：
  - 智能检测用户意图转移，支持主动切换意图处理
  - 区分打岔（闲聊、信息查询）和真正的意图转移
  - 支持嵌套意图处理，可暂停当前意图处理新意图
  - 保持原意图上下文，支持打岔后返回原意图。
- **完整槽位填充验证**：
  - LLM粗提取实体，Duckling标准化特定类型（如日期、数字）
  - 结合SlotConfig的validation规则校验
  - 槽位完整性检查：必需槽位未填充时主动询问
  - 支持槽位依赖关系和条件验证
  - 智能槽位继承：跨意图和跨会话的槽位值复用。
- **上下文智能管理**：
  - 集成ConversationChain维护多轮对话上下文
  - 支持会话级、意图级、槽位级的上下文管理
  - 跨会话的用户偏好记忆和历史上下文利用
  - 基于历史记录的个性化反问生成。
- **工具集成**：Duckling作为Langchain Tool，用于实体解析；支持混合Prompt Template配置策略：
  - **基础模板**：配置文件中定义通用的槽位提取prompt template
  - **意图专用模板**：数据库中存储特定意图的专用prompt template
  - **模板变量**：支持动态变量替换和上下文注入。检测输入sanitization，以防注入风险。
  - **版本管理**：数据库中记录模板变更历史和A/B测试版本
- **多层级错误处理**：
  - 意图识别失败 → 调用RAGFLOW API
  - 槽位填充不完整 → 智能反问补全
  - 置信度低 → 基于阈值策略处理
  - API调用失败 → 友好错误提示和重试机制。定义最大重试次数上限，如3次，以防无限循环。

## 4. 统一API接口功能
- **Endpoint定义**：POST /chat/interact，支持用户输入处理。
- **请求处理**：接收user_id、input和context，加载配置后执行无状态意图识别。添加输入校验层，如防SQL注入。
- **无状态意图识别流程**：
  - 从缓存加载意图配置和槽位定义
  - 分析用户输入的意图类型和槽位值
  - 执行意图匹配和置信度评估
  - 对于不完整的意图，返回提示信息要求前端提供完整信息。支持传入context参数模拟状态，以兼容多轮交互需求。
- **智能响应路由**：
  - 意图识别成功且槽位完整 → 返回API调用结果
  - 意图识别成功但槽位不完整 → 返回槽位补全提示
  - 意图识别有歧义 → 返回澄清问题
  - 非意图输入(闲聊) → 返回RAGFLOW API响应。
- **响应格式标准化**：返回response、intent、slots、status、response_type、next_action和message_type。精简字段，避免status和response_type重叠。
- **核心处理流程**：加载配置 → 意图识别 → 槽位处理 → 歧义检测 → API调用/RAGFLOW路由 → 返回结果。

## 5. 无状态请求处理功能
- **无状态设计**：
  - B2B架构下采用无状态设计，每次请求都是独立的业务处理
  - 前端系统发送完整的用户输入，无需多轮对话
  - 系统不维持用户状态，每次请求都从缓存加载意图配置。
- **意图匹配与处理**：
  - 系统自动分析用户输入的意图类型
  - 从缓存中匹配意图定义和槽位配置
  - 执行槽位提取和验证，直接返回处理结果
- **缓存优化**：使用Redis缓存意图配置、槽位配置和常用的NLU结果。
- **请求追踪**：使用request_id进行请求追踪和审计日志记录。

## 6. Function Calling功能
- **条件式API调用**：仅在意图识别成功且所有必需槽位完整填充后触发API调用。
- **外部API调用**：根据FunctionCallConfig，使用槽位参数调用指定endpoint（e.g., POST方法）。添加类型转换失败处理，如默认值或错误提示。
- **参数映射与验证**：从slots映射到API params，支持JSON格式，包含参数类型校验和格式转换。
- **错误与重试**：集成retry_times，支持success/error_message响应，包含详细错误码和重试策略。设置全局重试上限，如3次，以防资源滥用。
- **智能触发机制**：
  - 槽位完整性检查：必需槽位全部填充
  - 业务规则验证：支持复杂业务逻辑校验
  - 前置条件检查：API调用前的权限和状态验证。集成本地缓存权限，以减少延迟。
- **结果处理**：API调用成功后更新会话状态，失败时提供用户友好的错误信息。改为返回状态给前端维护，以符合无状态设计。

## 7. Admin API功能（管理画面后端）
- **认证**：使用JWT或API Key，确保仅授权访问。
- **配置维护**：提供/intents、/slots、/function_calls的CRUD endpoints，支持批量操作。
- **审计日志**：记录变更行动、用户和细节，存储在ConfigAuditLog表。
- **扩展支持**：集成前端UI（e.g., Vue.js），实现表单式配置编辑和版本回滚。

## 8. RAGFLOW集成与上下文感知功能
- **RAGFLOW API集成**：当输入非意图时，无缝调用RAGFLOW对话引擎API获取响应。添加API健康检查和备用fallback。
- **上下文感知反向提问**：
  - 意图歧义时，基于用户历史对话和当前上下文生成精准澄清问题
  - 槽位不完整时，智能生成补全询问，避免重复提问
  - 支持多轮对话中的上下文继承和推理。明确在无状态下由前端传入上下文。
- **智能路由决策**：
  - 基于置信度阈值和业务规则的智能路由
  - 支持意图识别结果的二次验证和修正
  - 动态调整路由策略以优化用户体验。

## 9. 测试与验证功能
- **单元测试**：覆盖意图识别准确率（>90%）、槽位填充完整性、配置CRUD和热更新。
- **集成测试**：E2E模拟多轮对话、意图歧义处理、Function Call成功/失败，以及性能负载测试。
- **场景验证**：测试配置维护、RAGFLOW集成、上下文感知反问和LLM延迟优化。扩展到多语言歧义等边缘案例，并使用自动化测试框架。
- **歧义处理测试**：验证意图歧义检测准确性和澄清问题生成质量。

## 10. Dockerfile&Docker-compose
- **Dockerfile**：生成Dockerfile。
- **docker-compose**：生成docker-compose.yaml。
- **.env**：系统所用参数放在 .env，docker-compose.yaml从.env中读取参数。
